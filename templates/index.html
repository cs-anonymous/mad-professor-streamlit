<!DOCTYPE html>
<html>
<head>
    <title>æš´èºçš„æ•™æˆè¯»è®ºæ–‡</title>
    <!-- æ–°å¢Ant Design -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.8/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/antd@4.24.8/dist/antd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>

</head>

<body>
    <div class="container">
        <!-- å·¦ä¾§èœå•æ  -->
        <div class="left-sidebar">
            <h2>ğŸ“š è®ºæ–‡åˆ—è¡¨</h2>
            <button class="ant-btn ant-btn-circle toggle-btn" onclick="toggleSidebar('left')">â—€</button>
            
            <div class="ant-select ant-select-single">
                <div class="ant-select-selector">
                    <select id="paper-select" class="ant-select-selection-search-input">
                        {% for paper in papers %}
                        <option value="{{ paper.id }}">{{ paper.title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        
            <form class="ant-upload ant-upload-drag" enctype="multipart/form-data">
                <input 
                  type="file" 
                  class="ant-upload-input" 
                  accept=".pdf,.jpg" 
                  multiple
                  onchange="handleFileSelect(event)"
                >
                <div class="ant-upload-text">
                  <span class="ant-upload-drag-icon">ğŸ“¤</span>
                  <p>æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</p>
                </div>
            </form>
        </div>

        <!-- ä¸­é—´å†…å®¹åŒº -->
        <div class="main-content">
            <h2>ğŸ“„ è®ºæ–‡å†…å®¹</h2>
            <div id="paper-content">
                {% if selected_paper %}
                <div id="paper-renderer" class="prose">
                    <!-- åˆ é™¤paperå˜é‡å¼•ç”¨ -->
                </div>
                {% endif %}
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©æ  -->
        <div class="right-sidebar">
            <div class="lang-switch">
                <button onclick="switchLanguage('zh')">ä¸­æ–‡</button>
                <button onclick="switchLanguage('en')">English</button>
            </div>
            <h2>ğŸ’¬ AIå¯¹è¯</h2>
            <div class="ant-comment-inner" id="chat-messages"></div>
            
            <div class="ant-input-group">
                <input type="text" 
                       id="user-input" 
                       class="ant-input"
                       placeholder="è¾“å…¥é—®é¢˜..."
                       style="width: calc(100% - 80px)">
                <button 
                    class="ant-btn ant-btn-primary" 
                    onclick="submitQuestion()"
                    style="width: 70px; margin-left: 10px">
                    å‘é€
                </button>
            </div>
            <button class="ant-btn ant-btn-circle toggle-btn" onclick="toggleSidebar('right')">â–¶</button>
        </div>

        </div>
    </div>
</body>
</html>

<script>
// ä¿®æ”¹åˆå§‹åŒ–é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    const initialPaperId = "{{ selected_paper }}";
    if(initialPaperId) {
        // é€šè¿‡APIè·å–è®ºæ–‡å†…å®¹
        fetch(`/paper/${initialPaperId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('paper-renderer').innerHTML = data.zh_content;
                renderKatex();
            });
    }
});


// åˆå§‹åŒ–å‡½æ•°
function initPaperContent(paperId) {
    fetch(`/paper/${paperId}`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('paper-content');
            content.innerHTML = data.zh_content; // æ ¹æ®è¯­è¨€åˆ‡æ¢
            renderKatex(); // è°ƒç”¨KaTeXæ¸²æŸ“
        });
}

// æäº¤é—®é¢˜å‡½æ•°
function submitQuestion() {
    const input = document.getElementById('user-input').value;
    fetch('/chat', {
        method: 'POST',
        body: JSON.stringify({
            prompt: input,
            paper_id: currentPaperId // éœ€è¦ç»´æŠ¤å½“å‰è®ºæ–‡ID
        }),
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        appendChatMessage(data.response);
    });
}

// KaTeXæ¸²æŸ“å‡½æ•°ï¼ˆJSå®ç°ï¼‰
function renderKatex() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false
    });
    // document.querySelectorAll('.arithmatex:not(.rendered)').forEach(el => {
    //     katex.render(el.textContent, el, { throwOnError: false });
    //     el.classList.add('rendered'); // æ ‡è®°å·²æ¸²æŸ“
    // });
}

function toggleSidebar(side) {
    const left = document.querySelector('.left-sidebar');
    const right = document.querySelector('.right-sidebar');
    
    if(side === 'left') {
        left.style.flex = left.style.flex === '0' ? '1' : '0';
        document.querySelector('.left-sidebar .toggle-btn').innerHTML = 
            left.style.flex === '0' ? 'â–¶' : 'â—€';
    } else {
        right.style.flex = right.style.flex === '0' ? '1' : '0';
        document.querySelector('.right-sidebar .toggle-btn').innerHTML = 
            right.style.flex === '0' ? 'â—€' : 'â–¶';
    }
}

function handleFileSelect(e) {
const files = e.target.files;
    // æ‰‹åŠ¨å®ç°æ–‡ä»¶æ ¡éªŒï¼ˆæ¨¡æ‹ŸbeforeUploadï¼‰
    if (files[0].size > 1024 * 1024 * 100) {
        alert('æ–‡ä»¶å¤§å°è¶…è¿‡100MBé™åˆ¶');
        return;
    }
    // æ‰‹åŠ¨æäº¤åˆ°FastAPIæ¥å£
    const formData = new FormData();
    formData.append('file', files[0]);
    fetch('/upload', { method: 'POST', body: formData })
    .then(response => response.json())
    .then(data => console.log('ä¸Šä¼ æˆåŠŸ', data));
}

// åˆå§‹åŒ–æ—¶åŠ è½½é»˜è®¤é€‰ä¸­çš„è®ºæ–‡
document.addEventListener('DOMContentLoaded', function() {
    const initialPaperId = "{{ selected_paper }}";
    if(initialPaperId) {
        loadPaperContent(initialPaperId);
    }
});

// è®ºæ–‡é€‰æ‹©äº‹ä»¶å¤„ç†
document.getElementById('paper-select').addEventListener('change', function(e) {
    loadPaperContent(e.target.value);
});

async function loadPaperContent(paperId) {
    try {
        const response = await fetch(`/paper/${paperId}`);
        const data = await response.json();
        
        const contentDiv = document.getElementById('paper-renderer');
        const lang = document.querySelector('input[name="lang-toggle"]:checked').value;
        contentDiv.innerHTML = lang === 'zh' ? data.zh_content : data.en_content;
        
        // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
        renderKatex();
    } catch (error) {
        console.error('è®ºæ–‡åŠ è½½å¤±è´¥:', error);
    }
}
</script>
